package me.zhengjie.modules.finance.repository;


import me.zhengjie.modules.finance.domain.FundFlowing;
import me.zhengjie.modules.finance.service.dto.FundFlowingExportDTO;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.sql.Timestamp;
import java.util.Date;
import java.util.List;
import java.util.Optional;


/**
* @author nmk
* @date 2019-08-22
*/
public interface FundFlowingRepository extends JpaRepository<FundFlowing, Long>, JpaSpecificationExecutor {

    FundFlowing findByTallyTypeIdAndTypeDictIdAndParkCostPevenueId(Long tallyTypeId, Long typeDictId, Long parkCostPevenueId);

    //根据收入支出Id和支付方式id
    List<FundFlowing> findByTypeDictIdAndParkCostPevenueId( Long typeDictId, Long parkCostPevenueId);

    @Query(value = " select distinct new me.zhengjie.modules.finance.service.dto.FundFlowingExportDTO( d.name  , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'房租\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'停车费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'地磅费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'往来款\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'投资款\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'水费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'电费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'其他费用\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'物业费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'税赋成本\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'违约金\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'管理费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'滞纳金\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd), ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :incomeId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'卫生费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'房租\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'水费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) ,( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'电费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'物业费\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'赋税成本\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'其他费用\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'往来款\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) , ( SELECT SUM(money) FROM FundFlowing WHERE dept.id = :deptId and typeDict.id = :expendId AND tally_type_id = (SELECT id FROM DictDetail WHERE label = \'投资款\') AND trad_date BETWEEN :tradDateStart AND :tradDateEnd) ) FROM FundFlowing f LEFT JOIN Dept d ON f.dept.id = d.id WHERE f.dept.id = :deptId")
    FundFlowingExportDTO findFundFlowingExportDto(@Param("deptId") Long deptId ,@Param("tradDateStart") Date tradDateStart , @Param("tradDateEnd") Date tradDateEnd,@Param("expendId") Long expendId , @Param("incomeId") Long incomeId);
}
